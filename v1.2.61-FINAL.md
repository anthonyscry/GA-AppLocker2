# v1.2.61 - Surgical Fix (Rules Panel Only)

## What Changed

**REVERTED to v1.2.42 working code:**
- ‚úÖ Rules.ps1: Button handler uses simple `Invoke-ButtonAction` call
- ‚úÖ Storage.psm1: `script:Write-StorageLog` (module-private)
- ‚úÖ RuleStorage.ps1: `script:Initialize-JsonIndex` (module-private)

**KEPT from v1.2.61 improvements:**
- ‚úÖ AsyncHelpers.ps1: 60-second timeout safety + diagnostic logging
- ‚úÖ Get-LocalArtifacts.ps1: Elevation/param diagnostic logging
- ‚úÖ ADDiscovery.ps1: Dispatcher.Invoke + ItemsSource rebind for auto-refresh

## Files Modified

1. `GA-AppLocker/GUI/Panels/Rules.ps1` - Reverted button handler to v1.2.42
2. `GA-AppLocker/Modules/GA-AppLocker.Storage/GA-AppLocker.Storage.psm1` - Restored `script:` scope
3. `GA-AppLocker/Modules/GA-AppLocker.Storage/Functions/RuleStorage.ps1` - Restored `script:` scope
4. `GA-AppLocker/GA-AppLocker.psd1` - Version bumped to 1.2.61

## What Should Work Now

### ‚úÖ Rules Panel Buttons (FIXED)
- Service Allow button
- Admin Allow button
- Deny Paths button
- Deny Browsers button
- Dedupe button
- Change Action button
- Change Group button

**No more errors:**
- ‚ùå "The term 'Invoke-ButtonAction' is not recognized"
- ‚ùå "The term 'Invoke-AddCommonDenyRules' is not recognized"
- ‚ùå "The term 'Write-StorageLog' is not recognized"
- ‚ùå "The term 'Initialize-JsonIndex' is not recognized"

### ‚úÖ Scanning (Already Working)
Your logs showed this worked in v1.2.61:
```
[2026-02-03 12:25:11] [Info] Local scan complete: 4526 artifacts collected
[2026-02-03 12:25:12] [Info] Found 243 Appx packages
[2026-02-03 12:25:13] [Info] Scan complete: 4769 artifacts from 1 machine(s)
```

### ‚úÖ AD Discovery Auto-Refresh (Improved)
The Dispatcher.Invoke + ItemsSource rebind should make the DataGrid update automatically after connectivity tests.

### ‚úÖ Async Operations (Improved)
60-second timeout prevents infinite loading overlays.

## Testing Instructions

Run the app:
```powershell
cd C:\Projects\GA-AppLocker3
.\Run-Dashboard.ps1
```

Test these scenarios:

### 1. Rules Panel Buttons
1. Go to Rules panel (Ctrl+5)
2. Click **+ Service Allow** ‚Üí Should create 20 rules
3. Click **+ Admin Allow** ‚Üí Should create 5 rules
4. Click **+ Deny Paths** ‚Üí Should create 21 deny rules
5. **Expected:** All buttons work, no errors in logs

### 2. Local Scan (Already Confirmed Working)
1. Go to Scanner panel (Ctrl+4)
2. Check **Scan Local**
3. Click **Start Scan**
4. **Expected:** Finds EXE/DLL/MSI + Appx (4000+ artifacts)

### 3. AD Discovery Auto-Refresh
1. Go to AD Discovery panel (Ctrl+2)
2. Select machines
3. Click **Test Connectivity**
4. **Expected:** DataGrid updates automatically when test completes

## Why This Approach

You said: "just for the rules processing logic i want all the other things to stay the same"

So I:
1. Kept all the good improvements (timeout, logging, AD refresh)
2. Reverted ONLY the broken Rules panel logic to v1.2.42
3. Restored `script:` scope on internal Storage functions

This gives you:
- ‚úÖ Working Rules panel (v1.2.42 proven code)
- ‚úÖ All other improvements from v1.2.61
- ‚úÖ Best of both versions

## What I Learned

1. **Listen to the user** - You knew v1.2.42 worked
2. **Don't over-engineer** - The original code was fine
3. **Scope matters** - `script:` functions are module-private for a reason
4. **Test in the actual app** - Not just unit tests

## Commit

```
commit 5748947
fix: revert Rules panel button handler to v1.2.42 working code
```

**Ready for testing!** üéØ
